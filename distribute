#!/usr/bin/make -f

SCITECO_VERSION = 0.6
SCITECO_SRC = sciteco-$(SCITECO_VERSION).tar.gz

$(SCITECO_SRC):
	$(MAKE) dist

all : $(SCITECO_SRC) debian mingw-binary

# $(UBUNTU) sets the Ubuntu distribution and fixes the package's
# version
debian-prepare: debian-temp/
debian-temp/ : bundle
	mkdir debian-temp/
	(cd debian-temp/; \
	 cp ../$(SCITECO_SRC) \
	    sciteco_$(SCITECO_VERSION).orig.tar.gz; \
	 tar xzf sciteco_$(SCITECO_VERSION).orig.tar.gz; \
	 cp -r ../debian sciteco-$(SCITECO_VERSION)/; \
	)
ifneq ($(UBUNTU),)
	sciteco -e "@EB|debian-temp/sciteco-$(SCITECO_VERSION)/debian/changelog| \
                    <@FS/ unstable;/ $(UBUNTU);/; -@S/)/R @I/ppa1~$(UBUNTU)1/ L> \
                    @EW||"
endif

SIGN ?= no
ifeq ($(SIGN),yes)
DEBUILD_FLAGS :=
else
DEBUILD_FLAGS := -us -uc
endif

UPLOAD_SRC ?= yes
ifeq ($(UPLOAD_SRC),yes)
DEBUILD_FLAGS += -sa
else
DEBUILD_FLAGS += -sd
endif

debian-source : debian-temp/source-stamp
debian-temp/source-stamp : debian-prepare
	(cd debian-temp/sciteco-$(SCITECO_VERSION)/; \
	 debuild -S $(DEBUILD_FLAGS); \
	)
	touch $@

debian-binary : debian-temp/binary-stamp
debian-temp/binary-stamp : debian-prepare
	(cd debian-temp/sciteco-$(SCITECO_VERSION)/; \
	 debuild -b $(DEBUILD_FLAGS); \
	)
	touch $@

debian : debian-source debian-binary

ppa : debian-source
	(cd debian-temp/; \
	 dput ppa:robin-haberkorn/sciteco *.changes; \
	)

mingw-binary : sciteco-$(SCITECO_VERSION)-win32.zip
sciteco-$(SCITECO_VERSION)-win32.zip : $(SCITECO_SRC)
	tar xzf $(SCITECO_SRC)
	(cd sciteco-$(SCITECO_VERSION); \
	 ./configure --host=i686-w64-mingw32 --prefix=/ \
		     --with-interface=pdcurses \
		     --with-default-scitecopath=lib \
		     --disable-bootstrap \
		     --enable-html-manual \
		     CFLAGS="-g -O3" CXXFLAGS="-g -O3"; \
	)
	$(MAKE) -C sciteco-$(SCITECO_VERSION) \
		install DESTDIR=`pwd`/temp-install
	rm -rf sciteco-$(SCITECO_VERSION)/
	i686-w64-mingw32-strip -s temp-install/bin/*
	mkdir temp-bin/
	cp -r temp-install/bin/* temp-install/share/sciteco/* temp-install/share/doc/sciteco/* \
	   temp-bin/
	rm -rf temp-install/
	cp /usr/i686-w64-mingw32/bin/intl.dll \
	   /usr/i686-w64-mingw32/bin/libglib-2.0-0.dll \
	   /usr/i686-w64-mingw32/bin/pdcurses.dll \
	   temp-bin/
	cd temp-bin/; zip -r ../$@ *
	rm -rf temp-bin/

clean:
	rm -rf $(SCITECO_SRC)
	rm -rf debian-temp/
	rm -rf sciteco-$(SCITECO_VERSION)/
